#!/bin/bash
#
# findBox
#
# (c) Miguel Leitao, 2016
# Part of meoRemote: https://github.com/miguelleitao/meoRemote
#
# Scans network for available meoBoxes.
#
# Usage: ./findBox [-q] [-c] [NetMaskLenLimit [NetAddr]]
#     NetAddr defaults to addresses from all available net interfaces.
#     NetMaskLenLimit defaults to 28. Use 24 for a wider search.
#     -q: quiet mode (no header)
#     -c: config file mode. Use ./findBox -c >appname.conf
#
mask=28
if [ "$1" == "-q" ]; then
    quiet=1
    shift
fi
if [ "$1" == "-c" ]; then
    quiet=1
    conf=1
	#" |awk -c '{print \"box \" $5}"
    shift
fi
[ "$1" != "" ] && mask=$1
[ "$quiet" != "1" ] && echo "# meoBoxes found:"
addrs=`ifconfig | grep  -e 'inet .*' |grep -v 127.0.0.1 |cut -f2 -dt |cut -d' ' -f2`
[ "$2" != "" ] && addrs=$2
#echo "adds: " $addrs
for i in $addrs; do
  #echo $i
  nmask=`ifconfig |grep inet |grep $i |cut -f3 -dt |cut -f2 -dk |cut -d' ' -f2`
  #echo "netmask: "$nmask
  IFS=. read -r ia1 ia2 ia3 ia4 <<< "$i"
  IFS=. read -r im1 im2 im3 im4 <<< "$nmask"
  naddr="$((ia1 & 255)).$((ia2 & 255)).$((ia3 & 255)).$((ia4 & im4))"
  #echo "netaddr:"$naddr
  if [ "$conf" != "1" ]; then
    nmap -n -p T:8082 -Pn --open -oG - $naddr/$mask |grep open/tcp |cut -f2 -d' '
  else
    nmap -n -p T:8082 -Pn --open -oG - $naddr/$mask |grep open/tcp |awk -c '{print "box " $2}'
  fi
done

